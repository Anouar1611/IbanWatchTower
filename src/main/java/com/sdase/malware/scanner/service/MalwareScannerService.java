package com.sdase.malware.scanner.service;

import com.sdase.malware.scanner.topic.CheckEvent;
import com.sdase.malware.scanner.topic.CheckResultEvent;
import com.sdase.malware.scanner.util.IbanUtils;
import com.sdase.malware.scanner.util.PdfUtils;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.stereotype.Service;

@Service
public class MalwareScannerService {

    private final KafkaTemplate<String, CheckResultEvent> kafkaTemplate;

    public MalwareScannerService(KafkaTemplate kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;
    }

    public void processDocument(CheckEvent event) {
        try {
            String content = PdfUtils.extractTextFromPdf(event.getUrl());
            boolean isBlacklisted = IbanUtils.checkIban(content);
            CheckResultEvent resultEvent = new CheckResultEvent(
                    isBlacklisted ? CheckResultEvent.StateEnum.SUSPICIOUS : CheckResultEvent.StateEnum.OK,
                    "IBANCheck",
                    "Check completed with IBAN status: " + (isBlacklisted ? "Blacklisted" : "Clear"));
            kafkaTemplate.send("checkResultEvents", resultEvent);
        } catch (Exception e) {
            kafkaTemplate.send("checkResultEvents", new CheckResultEvent(CheckResultEvent.StateEnum.ERROR, "IBANCheck", "Error processing document"));
        }
    }
}


